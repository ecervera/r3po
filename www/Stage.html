<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />
	<link rel="stylesheet" href="./css/codemirror.css">
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>

	<script src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
	<script src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
		
	<script src="js/codemirror.js"></script>
	<script src="mode/python/python.js"></script>
	
	<script src="js/stagebot.js"></script>
	<script src="js/stagesim.js"></script>
	
	<script>

	var rosURL = 'ws://'+location.hostname+':9090';
	var botName = '';

	var ros = new ROSLIB.Ros({
		url : rosURL
	});
		
// 	window.onbeforeunload=function(){
// 		var killBot = new ROSLIB.Service({
// 			ros : ros,
// 			name : '/kill',
// 			serviceType : 'stagesim/Kill'
// 		});
// 		var request = new ROSLIB.ServiceRequest({
// 			name : botName
// 		});
// 		killBot.callService(request, function(){});
// 		
// 		var stopBotRecord = new ROSLIB.Service({
// 			ros : ros,
// 			name : '/bot_recorder/stop',
// 			serviceType : 'r3po/BotStopRecord'
// 		});
// 		stopBotRecord.callService(request, function(result){});
// 	};
		
	$(document).ready(function(){
		var context = document.getElementById('world').getContext('2d');
		
		var stageSim = new StageSim({
			ros     : ros,
			context : context,
			background : 'images/lab.png'
		});

// 		var spawnBot = new ROSLIB.Service({
// 			ros : ros,
// 			name : '/spawn',
// 			serviceType : 'stagesim/Spawn'
// 		});
// 	
// 		var request = new ROSLIB.ServiceRequest({
// 			name : 'lab.world'
// 		});
// 	
// 		spawnBot.callService(request, function(result){
// 			botName = result.name;
// 			stageSim.spawnBot(botName);
// 			stageSim.draw();			
// 			
// 			var startBotRecord = new ROSLIB.Service({
// 				ros : ros,
// 				name : '/bot_recorder/start',
// 				serviceType : 'r3po/BotStartRecord'
// 			});
// 			var reqrec = new ROSLIB.ServiceRequest({
// 				name : botName
// 			});
// 			startBotRecord.callService(reqrec, function(result){
// 			});
// 		});
		botName = 'stage15';
		stageSim.spawnBot(botName);
    
		var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("moduleCode"),{
			lineNumbers : true
		});
		
		$('.CodeMirror').resizable({
			resize: function() {
				myCodeMirror.setSize("100%", Math.max(248,$(this).height()));
			}
		});
		
 		var runscServer  = '/stage_run_script';
 		var runscAction  = '/r3po/RunScriptAction';
 		var runningGoal;
 		
 		var runscClient = new ROSLIB.ActionClient({
 			ros : ros,
 			serverName : runscServer,
 			actionName : runscAction
 		});
		
		$( "#moduleRun" ).button();
		$( "#moduleStop" ).button();
		$( "#moduleStop" ).button('disable');
		
		$( "#moduleStop" ).on( "click", function( event, ui ) {
			runningGoal.cancel();
		} );
		
		$( "#moduleRun" ).on( "click", function( event, ui ) {
			$( "#moduleRun" ).button('disable');
			$( "#moduleStop" ).button('enable');
			var goal = new ROSLIB.Goal({
				actionClient : runscClient,
				goalMessage : {
					name : botName,
					code : myCodeMirror.getValue(),
				}
			});
			goal.on('feedback', function(feedback) {});
			goal.on('result', function(result) {
				var filename = result.name
				document.getElementById("moduleOutput").value += result.output;
				$( "#moduleRun" ).button('enable');
				$( "#moduleStop" ).button('disable');
			});
			goal.send();
			runningGoal = goal;
		} );
		
		$( "#clearOutput" ).button();
		$( "#clearOutput" ).on( "click", function( event, ui ) {
			document.getElementById("moduleOutput").value = ""
		});
	});

</script>
</head>

<body>
<table>
	<tr>
		<td>
		</td>
		<td>Script:
		</td>
	</tr>
	<tr>
		<td>
			<canvas id="world" width="600" height="600" style="border: 0px"></canvas>
		</td>
		<td bgcolor="#ffffff" >
<textarea  rows="40" cols="50" id="moduleCode">
#!/usr/bin/env python

import rospy

from geometry_msgs.msg import Twist
rospy.init_node('robot_mover',anonymous=True)

pub = rospy.Publisher('stage15/cmd_vel', Twist)
rospy.sleep(0.1)

twist = Twist()
twist.linear.x = 1.0  
twist.angular.z = 0.0

for i in range(10):
	pub.publish(twist)
	rospy.sleep(0.1)

</textarea>
		</td>
	</tr>
	<tr>
		<td align="center">
			<div id="moduleRun">Run</div>
			<div id="moduleStop">Stop</div>
		</td>
		<td >Output:<br>
			<textarea readonly rows="5" cols="50" style="overflow:auto;resize:vertical" id="moduleOutput"></textarea>
	</td>
	</tr>
	<tr>
		<td align="center">
		</td>
		<td align="center">
			<div id="clearOutput">Clear output</div>
		</td>
	</tr>
	</table>
</body>

</html>
